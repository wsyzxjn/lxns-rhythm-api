<cite>
**本文档中引用的文件**
- [LxnsApiCLient.ts](file://src/client/LxnsApiCLient.ts)
- [types.ts](file://src/client/types.ts)
- [models.ts](file://src/apis/maimai/models.ts)
- [README.md](file://README.md)
- [index.ts](file://tests/index.ts)
</cite>

# 资源获取功能

## 目录
1. [简介](#简介)
2. [getAsset 方法详解](#getasset-方法详解)
3. [参数说明](#参数说明)
4. [返回值与异步处理](#返回值与异步处理)
5. [使用示例](#使用示例)
6. [环境适配指南](#环境适配指南)
7. [缓存与速率限制](#缓存与速率限制)
8. [集成建议](#集成建议)

## 简介

`LxnsApiClient` 是一个用于访问 Lxns API 的轻量级 TypeScript SDK，专为节奏游戏数据交互设计。该客户端不仅支持获取玩家信息、歌曲数据等核心功能，还提供了一个便捷的方法 `getAsset`，用于下载与游戏相关的静态资源文件。这些资源包括封面图、图标、称号、姓名框和音频等，是构建完整游戏体验的重要组成部分。

本指南将深入介绍 `getAsset` 方法的使用方式，帮助开发者理解其工作原理，并正确地将其集成到自己的项目中。

## getAsset 方法详解

`getAsset` 方法是 `LxnsApiClient` 提供的一个实用工具，允许开发者通过指定资源类型和唯一标识符来异步下载二进制资源文件。此方法挂载在客户端实例的 `maimai` 命名空间下，无论是否提供认证令牌（token），均可使用。

该方法的设计目标是简化资源获取流程，使开发者无需手动构造复杂的 URL 或处理底层 HTTP 请求细节。它直接封装了对资源服务器的调用逻辑，并返回标准化的二进制数据流，便于后续处理。

```mermaid
flowchart TD
A[调用 getAsset(type, id)] --> B{验证参数}
B --> C[构造资源URL]
C --> D[发起HTTP GET请求]
D --> E[接收ArrayBuffer响应]
E --> F[转换为Buffer对象]
F --> G[返回Promise<Buffer>]
```

**Diagram sources**
- [LxnsApiCLient.ts](file://src/client/LxnsApiCLient.ts#L57-L65)

**Section sources**
- [LxnsApiCLient.ts](file://src/client/LxnsApiCLient.ts#L57-L65)
- [types.ts](file://src/client/types.ts#L24)

## 参数说明

`getAsset` 方法接受两个必需参数：`type` 和 `id`，它们共同决定了要下载的具体资源。

### type（资源类型）

`type` 参数是一个字符串，表示请求的资源类别。根据代码定义，合法的资源类型由 `AssetType` 枚举限定，具体包括：

- `'jacket'`：代表歌曲封面图
- `'icon'`：代表玩家头像图标
- `'plate'`：代表玩家称号
- `'frame'`：代表玩家姓名框
- `'music'`：代表音频文件（如歌曲MP3）

该参数确保请求指向正确的资源目录，避免因路径错误导致的404问题。

### id（资源唯一标识符）

`id` 参数是一个数字，表示对应资源的唯一标识符。例如，在请求歌曲封面时，`id` 即为该歌曲在系统中的主键ID。此ID通常来源于其他API接口返回的数据结构中，如 `Song` 对象的 `id` 字段。

结合 `type` 和 `id`，SDK 可以精确生成目标资源的完整URL，格式如下：
```
https://assets2.lxns.net/maimai/{type}/{id}.png   // 图片类资源
https://assets2.lxns.net/maimai/{type}/{id}.mp3   // 音频类资源（仅 music 类型）
```

**Section sources**
- [LxnsApiCLient.ts](file://src/client/LxnsApiCLient.ts#L57-L65)
- [models.ts](file://src/apis/maimai/models.ts#L300)

## 返回值与异步处理

`getAsset` 方法的返回值是一个 `Promise<Buffer>` 类型的对象，表示一个异步操作的结果，最终解析为包含二进制数据的 `Buffer` 实例。

选择 `Buffer` 作为返回类型的原因在于其跨平台兼容性：
- 在 Node.js 环境中，`Buffer` 是原生支持的二进制数据容器，可直接写入文件系统。
- 在浏览器环境中，可通过 `Blob` 构造函数将 `Buffer` 转换为 `Blob` 对象，进而创建可用于 `<img>` 标签的 URL。

由于网络请求 inherently 是异步的，因此必须使用 `async/await` 或 `.then()` 语法等待结果完成后再进行后续处理。

**Section sources**
- [types.ts](file://src/client/types.ts#L24)
- [LxnsApiCLient.ts](file://src/client/LxnsApiCLient.ts#L57-L65)

## 使用示例

以下是一个典型的 `getAsset` 调用示例，展示如何下载 ID 为 `1001` 的歌曲封面并保存为本地文件。

```ts
import { LxnsApiClient } from "lxns-rhythm-api";
import fs from "node:fs/promises";

const client = new LxnsApiClient();

// 下载歌曲封面
const jacketBuffer = await client.maimai.getAsset("jacket", 1001);

// 保存为本地文件
await fs.writeFile("cover_1001.png", jacketBuffer);
```

上述代码首先创建一个 `LxnsApiClient` 实例，然后调用 `getAsset` 方法请求类型为 `'jacket'`、ID 为 `1001` 的资源。待 Promise 解析后，使用 Node.js 内置的 `fs/promises` 模块将 `Buffer` 数据写入磁盘。

**Section sources**
- [index.ts](file://tests/index.ts#L1-L8)

## 环境适配指南

### 在 Node.js 中使用

在 Node.js 环境中，`Buffer` 可直接与文件系统模块配合使用。推荐使用 `fs/promises` 进行异步写入操作，以保持非阻塞特性。

```ts
await fs.writeFile("output.png", bufferData);
```

### 在浏览器中使用

在浏览器环境中，需将 `Buffer` 转换为 `Blob`，再通过 `URL.createObjectURL()` 创建临时 URL 供 HTML 元素使用。

```ts
// 假设从某处获得 Buffer 数据（例如通过 WebSocket 或 Fetch API）
const blob = new Blob([buffer], { type: "image/png" });
const imageUrl = URL.createObjectURL(blob);

// 用于 img 标签
document.getElementById("cover").src = imageUrl;
```

注意：当前 SDK 主要针对 Node.js 设计，若在浏览器中使用，可能需要额外的打包配置（如 Webpack 或 Vite）来处理 `Buffer` 兼容性问题。

**Section sources**
- [index.ts](file://tests/index.ts#L1-L8)

## 缓存与速率限制

### 缓存策略

目前 `getAsset` 方法本身不内置客户端缓存机制。然而，资源托管于 CDN 服务（`assets2.lxns.net`），具备以下优势：
- **边缘节点缓存**：CDN 自动缓存热门资源，提升全球访问速度。
- **HTTP 缓存头支持**：服务器应返回适当的 `Cache-Control` 和 `ETag` 头，浏览器或代理服务器可据此实现条件请求。

建议开发者在应用层实现内存或本地存储缓存，避免重复请求相同资源。

### 速率限制

文档未明确提及对 `getAsset` 接口的速率限制。但由于其面向公共资源，预计存在基于 IP 或 token 的限流策略。建议：
- 避免高频轮询或批量下载。
- 实现退避重试机制以应对临时限流。
- 对于大量资源需求，考虑预加载或离线包方案。

**Section sources**
- [LxnsApiCLient.ts](file://src/client/LxnsApiCLient.ts#L57-L65)
- [README.md](file://README.md#L1-L105)

## 集成建议

为确保 `getAsset` 功能的稳定集成，请遵循以下最佳实践：
1. **参数校验**：在调用前验证 `type` 是否属于合法枚举值，`id` 是否为正整数。
2. **错误处理**：使用 `try-catch` 包裹异步调用，妥善处理网络异常或404资源不存在的情况。
3. **资源释放**：在浏览器中使用 `URL.revokeObjectURL()` 及时释放创建的临时 URL，防止内存泄漏。
4. **类型安全**：利用 TypeScript 的类型推导能力，确保传参符合 `AssetType` 和 `number` 类型约束。

通过合理使用 `getAsset` 方法，开发者可以高效地集成高质量的游戏资源，提升用户体验。

**Section sources**
- [LxnsApiCLient.ts](file://src/client/LxnsApiCLient.ts#L57-L65)
- [types.ts](file://src/client/types.ts#L24)
- [models.ts](file://src/apis/maimai/models.ts#L300)