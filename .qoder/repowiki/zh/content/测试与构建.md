# 测试与构建

<cite>
**本文档中引用的文件**
- [package.json](file://package.json)
- [tsup.config.ts](file://tsup.config.ts)
- [tests/index.ts](file://tests/index.ts)
- [src/index.ts](file://src/index.ts)
</cite>

## 目录
1. [简介](#简介)
2. [开发脚本命令](#开发脚本命令)
3. [测试流程说明](#测试流程说明)
4. [打包配置详解](#打包配置详解)
5. [本地复现CI/CD流程](#本地复现cicd流程)

## 简介
本文档为开发者提供关于项目测试和构建流程的实用指南。详细说明如何运行单元测试、理解打包配置以及执行开发常用命令，帮助贡献者快速上手并确保代码质量符合标准。

## 开发脚本命令
从 `package.json` 文件中提取的 `scripts` 字段列出了所有可用的开发命令：

| 命令 | 描述 |
|------|------|
| `dev` | 未定义（当前无对应脚本） |
| `build` | 执行 `tsup` 命令进行生产环境构建 |
| `build:production` | 设置 `NODE_ENV=production` 后执行 `tsup` 构建，并启用压缩 |
| `lint` | 使用 ESLint 检查 `src` 目录下的 `.ts` 和 `.js` 文件 |
| `prettier` | 使用 Prettier 格式化 `src` 目录下所有 `.ts` 文件 |
| `test` | 使用 `tsx` 运行 `tests/index.ts` 中的测试用例 |
| `prepublishOnly` | 发布前自动执行格式化和构建任务 |

这些脚本通过 `pnpm run <script-name>` 的方式调用，是日常开发的核心工具链。

**Section sources**
- [package.json](file://package.json#L28-L40)

## 测试流程说明
执行 `pnpm test` 命令后，测试框架会加载 `tests/index.ts` 文件并执行其中的测试逻辑。该测试文件主要验证 SDK 的核心功能是否正常工作。

当前测试流程包括：
1. 创建 `LxnsApiClient` 实例
2. 调用 `maimai.getAsset("jacket", 114)` 方法获取指定资源
3. 将返回的文件流写入本地 `114.png` 文件

此过程验证了客户端请求发送、API 接口调用及资源下载处理的完整链路正确性。

**Section sources**
- [tests/index.ts](file://tests/index.ts#L1-L8)
- [package.json](file://package.json#L36)

## 打包配置详解
`tsup.config.ts` 文件定义了项目的打包行为，使用 `tsup` 工具对 TypeScript 项目进行高效构建。

关键配置项解析如下：

| 配置项 | 值 | 说明 |
|--------|----|------|
| `entry` | `["src/index.ts"]` | 指定入口文件为 `src/index.ts` |
| `format` | `"esm"` | 输出格式为 ES Module |
| `target` | `es2022`（来自 tsconfig.json） | 编译目标为现代 JavaScript 环境 |
| `dts` | `true` | 自动生成类型声明文件（`.d.ts`） |
| `minify` | `isProduction` | 仅在生产环境下开启代码压缩 |
| `clean` | `true` | 构建前清除输出目录 |
| `outDir` | `"dist"` | 输出目录为 `dist` |
| `skipNodeModulesBundle` | `true` | 不打包 `node_modules` 中的依赖 |

当前配置仅生成 ESM 格式输出，适用于现代 Node.js 环境。若需支持 CommonJS，可扩展配置数组添加 `{ ...DEFAULT_CONFIG, format: "cjs" }`。

**Section sources**
- [tsup.config.ts](file://tsup.config.ts#L1-L20)
- [tsconfig.json](file://tsconfig.json#L3-L7)

## 本地复现CI/CD流程
为了确保代码更改符合质量标准，开发者应在提交前在本地完整复现 CI/CD 流程。推荐操作顺序如下：

1. **代码格式化**  
   ```bash
   pnpm run prettier
   ```
   统一代码风格，避免因格式问题导致构建失败。

2. **静态代码检查**  
   ```bash
   pnpm run lint
   ```
   检测潜在错误和不符合规范的代码。

3. **运行单元测试**  
   ```bash
   pnpm run test
   ```
   验证功能逻辑正确性，确保新增或修改的代码不影响现有功能。

4. **执行生产构建**  
   ```bash
   pnpm run build:production
   ```
   模拟发布时的构建流程，检查打包结果是否正常。

5. **预发布验证（自动触发）**  
   当执行 `pnpm publish` 时，`prepublishOnly` 钩子将自动运行 `prettier` 和 `build`，确保发布的包经过充分验证。

遵循上述流程可有效提升代码质量，减少集成问题。

**Section sources**
- [package.json](file://package.json#L37-L40)
- [tsup.config.ts](file://tsup.config.ts#L4-L10)
- [tests/index.ts](file://tests/index.ts#L1-L8)