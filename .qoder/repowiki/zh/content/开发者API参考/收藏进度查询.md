# 收藏进度查询

<cite>
**本文档引用文件**  
- [dev.ts](file://src/apis/maimai/dev.ts#L104-L148)
- [models.ts](file://src/apis/maimai/models.ts#L123-L186)
- [types/dev.ts](file://src/apis/maimai/types/dev.ts#L0-L41)
</cite>

## 目录
1. [接口概述](#接口概述)  
2. [参数说明](#参数说明)  
3. [响应结构解析](#响应结构解析)  
4. [使用示例](#使用示例)  
5. [权限与调用限制](#权限与调用限制)  
6. [缓存与性能建议](#缓存与性能建议)  

## 接口概述

`getCollectionProgress` 接口用于获取特定玩家在某一收藏品类别中的收集完成度信息，适用于头像、姓名框、背景图、称号等收藏品类型的进度追踪。该接口属于开发者 API（dev API）的一部分，需通过有效的 `devAccessToken` 进行身份验证后方可调用。

此接口可用于构建收藏成就追踪页面、提醒用户未解锁项目或分析玩家收集行为。

**Section sources**  
- [dev.ts](file://src/apis/maimai/dev.ts#L104-L148)

## 参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `friendCode` | number | 是 | 玩家的好友码，用于唯一标识目标用户 |
| `collectionType` | "trophy" \| "icon" \| "plate" \| "frame" | 是 | 收藏品类别：<br>• `trophy`: 称号<br>• `icon`: 头像<br>• `plate`: 姓名框<br>• `frame`: 背景图 |
| `collectionId` | number | 是 | 收藏品的唯一 ID |

请求路径格式为：`player/{friendCode}/{collectionType}/{collectionId}`

**Section sources**  
- [dev.ts](file://src/apis/maimai/dev.ts#L104-L148)

## 响应结构解析

响应体类型为 `CollectionProgress`，实际继承自 `Collection` 类型定义于 `models.ts` 中。其核心字段如下：

```typescript
interface Collection {
  id: number;
  name: string;
  color?: string;
  description?: string;
  genre?: string;
  required?: CollectionRequired[];
}
```

### 主要字段含义

- **`id`**: 收藏品的唯一编号。
- **`name`**: 收藏品名称（如“闪耀之星”）。
- **`color`**: 仅称号类收藏品存在，表示称号显示颜色。
- **`description`**: 收藏品描述信息。
- **`genre`**: 收藏品所属分类（日文标识）。
- **`required`**: 解锁该收藏品所需满足的条件列表，包含多个 `CollectionRequired` 条目。

#### `CollectionRequired` 结构

每个要求项可能包含以下条件之一或组合：

- `difficulties`: 需达成的谱面难度（BASIC, ADVANCED 等）
- `rate`: 所需评级类型（如 sssp, ap, fc 等）
- `fc` / `fs`: FULL COMBO 或 FULL SYNC 类型要求
- `songs`: 特定曲目完成要求，每首曲目包含：
  - `id`: 曲目 ID
  - `title`: 曲名
  - `completed`: 是否已完成
  - `completed_difficulties`: 已完成的难度索引数组

此外，`required` 数组本身还包含一个 `completed` 字段，表示该条目整体是否已满足。

**Section sources**  
- [models.ts](file://src/apis/maimai/models.ts#L123-L186)
- [types/dev.ts](file://src/apis/maimai/types/dev.ts#L0-L41)

## 使用示例

### 构建收藏成就追踪页面

1. 调用 `getCollectionList` 获取某类收藏品（如头像）的完整列表。
2. 对每个收藏品，使用 `getCollectionProgress(friendCode, 'icon', iconId)` 查询当前玩家的解锁状态。
3. 根据返回的 `completed` 字段判断是否已获得，并展示进度条或提示语。
4. 若未完成，可展开 `required` 字段，列出尚未达成的具体曲目或条件，引导玩家完成挑战。

### 提醒未解锁项目

结合前端轮询机制（注意频率控制），定期检查关键收藏品的进度变化。当发现新解锁项时，弹出通知提醒用户：“恭喜！您已解锁新头像【星辰大海】”。

```ts
const client = new LxnsApiClient({ devAccessToken: "your-token" });
const progress = await client.maimai.dev.getCollectionProgress(12345678, "trophy", 1001);

if (progress.required?.every(req => req.completed)) {
  console.log(`已解锁称号：${progress.name}`);
} else {
  const pending = progress.required?.filter(r => !r.completed);
  console.log("尚有未完成条件：", pending);
}
```

**Section sources**  
- [dev.ts](file://src/apis/maimai/dev.ts#L104-L148)
- [models.ts](file://src/apis/maimai/models.ts#L123-L186)

## 权限与调用限制

- **必须持有有效的 `devAccessToken`** 才能调用此接口。
- 无 token 或 token 无效将导致 401 Unauthorized 错误。
- 接口位于开发者 API 路径下，基础 URL 为 `<baseURL>/maimai/`。
- 滥用或高频调用可能导致 IP 限流或 token 封禁。

**Section sources**  
- [dev.ts](file://src/apis/maimai/dev.ts#L104-L148)
- [README.md](file://README.md#L45-L55)

## 缓存与性能建议

- 服务器端对玩家数据设有缓存机制，通常每小时更新一次。
- **不建议频繁轮询**（如每分钟调用），推荐间隔至少 10 分钟以上。
- 可结合本地客户端缓存策略，在两次同步之间使用本地存储的数据提升响应速度。
- 如需实时性更高的数据同步，建议通过事件驱动方式触发更新，而非持续拉取。

**Section sources**  
- [dev.ts](file://src/apis/maimai/dev.ts#L104-L148)
- [README.md](file://README.md#L60-L70)